#!/usr/bin/env node
/**
 * Generate block registry from page-builder blocks directory
 * This script scans the blocks directory and generates explicit imports
 * Run: node scripts/generate-registry.mjs
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Path to page-builder blocks (relative to this script)
// This assumes the consuming app has page-builder at ../page-builder
const blocksBasePath = path.resolve(__dirname, "../../sano/page-builder/blocks");

if (!fs.existsSync(blocksBasePath)) {
   console.error(`Blocks directory not found: ${blocksBasePath}`);
   console.error("Make sure you're running this from the vue-wswg-editor directory");
   process.exit(1);
}

// Find all block directories
const blocks = fs
   .readdirSync(blocksBasePath, { withFileTypes: true })
   .filter((dirent) => dirent.isDirectory())
   .map((dirent) => dirent.name)
   .sort();

console.log(`Found ${blocks.length} blocks:`, blocks.join(", "));

// Generate imports and exports
const imports = blocks
   .map((block) => {
      // Use relative path from the generated file location
      const relativePath = `../../../../sano/page-builder/blocks/${block}/${block}.vue`;
      const importName = block.replace(/-/g, "");
      return `import ${importName}Component from "${relativePath}";`;
   })
   .join("\n");

const exports = blocks
   .map((block) => {
      const importName = block.replace(/-/g, "");
      const camelCase = block
         .split("-")
         .map((word, i) => (i === 0 ? word : word[0].toUpperCase() + word.slice(1)))
         .join("");
      return `   "${block}": ${importName}Component,`;
   })
   .join("\n");

const registryContent = `// Auto-generated block registry
// DO NOT EDIT - This file is generated by scripts/generate-registry.mjs
// Run: npm run generate-registry to regenerate

${imports}

export const blockModules = {
${exports}
};

export const blockTypes = ${JSON.stringify(blocks, null, 2)} as const;
`;

const outputPath = path.resolve(
   __dirname,
   "../src/components/PageRenderer/blockRegistry.generated.ts"
);

fs.writeFileSync(outputPath, registryContent);
console.log(`âœ… Generated registry at: ${outputPath}`);

